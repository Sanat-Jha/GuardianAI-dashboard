{% extends 'base.html' %}
{% load dashboard_filters %}

{% block sidebar %}
  {# Include the sidebar component #}
  {% include 'dashboard/components/dashboard_sidebar.html' %}
{% endblock %}

{% block content %}
<script>
// Add dashboard-page class to body
document.body.classList.add('dashboard-page');
</script>

{# Add Child Modal #}
{% include 'dashboard/components/add_child_modal.html' %}

{# Main Content Container #}
<div class="dashboard-content">
  {# If no children exist, show empty state #}
  {% if not children %}
    <div class="flex items-center justify-center h-full">
      {% include 'dashboard/components/empty_state.html' %}
    </div>
  {% else %}
    {# Initial prompt to select a child #}
    <div id="selectPrompt" class="flex items-center justify-center min-h-[60vh]">
      {% include 'dashboard/components/select_child_prompt.html' %}
    </div>
    
    {# Child-specific content containers (hidden by default) #}
    {% for child, data in children_data.items %}
      <div id="child-{{ child.child_hash }}" class="child-dashboard hidden">
      
      {# Child Info Card #}
      {% with child=child %}
        {% include 'dashboard/components/child_info_card.html' %}
      {% endwith %}
      
      {# Check if child has any data #}
      {% if data.has_data %}
        
        {# Statistics Grid #}
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {% with label="Total Screen Time" value=data.stats.total_screen_time_hours subtitle="All-time usage" stat_id="stat-total-"|add:child.child_hash %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Average Daily" value=data.stats.avg_screen_time_formatted subtitle="Per day average" stat_id="stat-avg-"|add:child.child_hash %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Latest Location" value=data.stats.latest_location subtitle="Most recent GPS point" stat_id="stat-location-"|add:child.child_hash %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Blocked Sites" value=data.stats.blocked_sites subtitle=data.stats.site_access_count|stringformat:"d"|add:" total sites" stat_id="stat-block-"|add:child.child_hash %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
        </div>
        {# Screen Time Chart - Full Width #}
        <div class="w-full mb-6">
          {% with child_hash=child.child_hash %}
            {% include 'dashboard/components/screen_time_chart.html' %}
          {% endwith %}
        </div>
        
        {# App Usage Chart and Top Apps List in one row #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {% with child_hash=child.child_hash %}
            {% include 'dashboard/components/app_usage_chart.html' %}
          {% endwith %}
          {% with top_apps=data.top_apps child_hash=child.child_hash %}
            {% include 'dashboard/components/top_apps_list.html' %}
          {% endwith %}
        </div>
        {# Detailed Data Sections #}
        <div class="mt-6 space-y-6">
          {% with locations=data.locations location_count=data.stats.location_count child_hash=child.child_hash %}
            {% include 'dashboard/components/location_history.html' %}
          {% endwith %}
          
          {% with site_logs=data.site_logs site_count=data.stats.site_access_count child_hash=child.child_hash %}
            {% include 'dashboard/components/site_access_log.html' %}
          {% endwith %}
        </div>
        
      {% else %}
        {# No data available for this child #}
        {% include 'dashboard/components/no_data_message.html' %}
      {% endif %}
      
    </div>
  {% endfor %}
  {% endif %}
</div>

{# JavaScript #}
{% include 'dashboard/components/dashboard_scripts.html' %}

{# Styles #}
{% include 'dashboard/components/dashboard_styles.html' %}

{% endblock %}
