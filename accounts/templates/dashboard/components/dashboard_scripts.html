<script>
// Toggle Add Child Modal
function toggleAddChildModal() {
  const modal = document.getElementById('addChildModal');
  modal.classList.toggle('hidden');
}

// Close modal on outside click
document.getElementById('addChildModal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    toggleAddChildModal();
  }
});

// Child Selection Logic for Sidebar
window.selectChild = function(childHash) {
  console.log('Selecting child:', childHash);
  
  // Update active state in sidebar
  document.querySelectorAll('.child-item').forEach(item => {
    item.classList.remove('active-child');
    const indicator = item.querySelector('.child-indicator');
    if (indicator) {
      indicator.style.opacity = '0';
    }
  });
  
  // Set active state for selected child
  const selectedItem = document.querySelector(`[data-child-hash="${childHash}"]`);
  if (selectedItem) {
    selectedItem.classList.add('active-child');
    const indicator = selectedItem.querySelector('.child-indicator');
    if (indicator) {
      indicator.style.opacity = '1';
    }
  }
  
  // Hide all child dashboards
  document.querySelectorAll('.child-dashboard').forEach(dash => {
    dash.classList.add('hidden');
  });
  
  // Show/hide select prompt
  const selectPrompt = document.getElementById('selectPrompt');
  if (childHash) {
    if (selectPrompt) selectPrompt.classList.add('hidden');
    
    // Show selected child dashboard
    const selectedDash = document.getElementById('child-' + childHash);
    if (selectedDash) {
      selectedDash.classList.remove('hidden');
      console.log('Showing dashboard for child:', childHash);
      
      // Load charts for this child
      loadChartsForChild(childHash);
    } else {
      console.error('Dashboard not found for child:', childHash);
    }
  } else {
    if (selectPrompt) selectPrompt.classList.remove('hidden');
  }
}

// Load Charts Function
function loadChartsForChild(childHash) {
  // Check if charts already exist
  const lineCanvas = document.getElementById('lineChart' + childHash);
  const barCanvas = document.getElementById('barChart' + childHash);
  const appAnalyticsDiv = document.getElementById('appAnalytics' + childHash);
  
  if (!lineCanvas || !barCanvas) {
    console.error('Chart canvases not found for child:', childHash);
    return;
  }
  
  // Fetch chart data
  fetch('/dashboard/chart-data/' + childHash + '/')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.statusText);
      }
      return response.json();
    })
    .then(data => {
      console.log('Chart data loaded:', data);
      
      // Destroy existing charts if any
      if (window.chartsInstances && window.chartsInstances[childHash]) {
        window.chartsInstances[childHash].line?.destroy();
        window.chartsInstances[childHash].bar?.destroy();
      }
      
      // Initialize charts storage
      if (!window.chartsInstances) window.chartsInstances = {};
      if (!window.chartsInstances[childHash]) window.chartsInstances[childHash] = {};
      
      // 1. LINE CHART - Screen Time Trend with Gradient
      const lineCtx = lineCanvas.getContext('2d');
      const gradient = lineCtx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(35, 210, 226, 0.3)');
      gradient.addColorStop(1, 'rgba(35, 210, 226, 0.0)');
      
      window.chartsInstances[childHash].line = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: data.line_chart.labels,
          datasets: [{
            label: 'Screen Time (hours)',
            data: data.line_chart.data,
            borderColor: '#23D2E2',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#23D2E2',
            pointBorderColor: '#0F1B2A',
            pointBorderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: '#8EF6FF',
            pointHoverBorderColor: '#FFFFFF',
            pointHoverBorderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'end',
              labels: { 
                color: '#A9B3C1', 
                font: { size: 12, weight: '600', family: 'Inter' },
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(15, 27, 42, 0.95)',
              titleColor: '#8EF6FF',
              bodyColor: '#FFFFFF',
              borderColor: '#23D2E2',
              borderWidth: 2,
              padding: 12,
              titleFont: { size: 14, weight: '700', family: 'Inter' },
              bodyFont: { size: 13, family: 'Inter' },
              displayColors: false,
              callbacks: {
                title: function(tooltipItems) {
                  return 'Date: ' + tooltipItems[0].label;
                },
                label: function(context) {
                  return 'Usage: ' + context.parsed.y.toFixed(2) + ' hours';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: '#A9B3C1', 
                font: { size: 11, family: 'Inter' },
                callback: function(value) {
                  return value + 'h';
                }
              },
              grid: { 
                color: 'rgba(169, 179, 193, 0.08)',
                drawBorder: false
              },
              border: { display: false }
            },
            x: {
              ticks: { 
                color: '#A9B3C1', 
                font: { size: 11, family: 'Inter' },
                maxRotation: 45,
                minRotation: 45
              },
              grid: { 
                display: false
              },
              border: { display: false }
            }
          }
        }
      });

      // 2. HORIZONTAL BAR CHART - App Usage Distribution
      const barCtx = barCanvas.getContext('2d');
      
      // Calculate total time
      const totalTime = data.pie_chart.data.reduce((a, b) => a + b, 0);
      document.getElementById('totalAppTime' + childHash).textContent = totalTime.toFixed(1) + 'h';
      
      window.chartsInstances[childHash].bar = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: data.pie_chart.labels,
          datasets: [{
            label: 'Usage (hours)',
            data: data.pie_chart.data,
            backgroundColor: [
              'rgba(35, 210, 226, 0.9)',
              'rgba(142, 246, 255, 0.9)',
              'rgba(24, 164, 180, 0.9)',
              'rgba(123, 108, 246, 0.9)',
              'rgba(184, 167, 255, 0.9)',
            ],
            borderColor: [
              '#23D2E2',
              '#8EF6FF',
              '#18A4B4',
              '#7B6CF6',
              '#B8A7FF',
            ],
            borderWidth: 2,
            borderRadius: 8,
            barThickness: 32,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(15, 27, 42, 0.95)',
              titleColor: '#8EF6FF',
              bodyColor: '#FFFFFF',
              borderColor: '#23D2E2',
              borderWidth: 2,
              padding: 12,
              titleFont: { size: 13, weight: '600', family: 'Inter' },
              bodyFont: { size: 12, family: 'Inter' },
              displayColors: true,
              callbacks: {
                label: function(context) {
                  const hours = context.parsed.x.toFixed(2);
                  const percentage = ((context.parsed.x / totalTime) * 100).toFixed(1);
                  return hours + 'h (' + percentage + '%)';
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { 
                color: '#A9B3C1', 
                font: { size: 11, family: 'Inter' },
                callback: function(value) {
                  return value + 'h';
                }
              },
              grid: { 
                color: 'rgba(169, 179, 193, 0.08)',
                drawBorder: false
              },
              border: { display: false }
            },
            y: {
              ticks: { 
                color: '#FFFFFF', 
                font: { size: 12, weight: '500', family: 'Inter' }
              },
              grid: { 
                display: false
              },
              border: { display: false }
            }
          }
        }
      });

      // 3. APPLICATION ANALYTICS - Interactive List
      if (appAnalyticsDiv) {
        let analyticsHTML = '';
        
        if (data.pie_chart.labels[0] === 'No Data' || data.pie_chart.data.length === 0) {
          analyticsHTML = `
            <div class="text-center py-12">
              <svg class="w-16 h-16 mx-auto text-textsec/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <p class="text-textsec text-sm">No application data available</p>
              <p class="text-textsec/60 text-xs mt-1">Data will appear once the child uses their device</p>
            </div>
          `;
        } else {
          const maxTime = Math.max(...data.pie_chart.data);
          
          data.pie_chart.labels.forEach((app, index) => {
            const time = data.pie_chart.data[index];
            const percentage = ((time / totalTime) * 100).toFixed(1);
            const barWidth = (time / maxTime * 100).toFixed(1);
            const minutes = Math.round((time % 1) * 60);
            const hours = Math.floor(time);
            
            // Color variations
            const colors = [
              { bg: 'bg-cyan-500/20', border: 'border-cyan-500/40', text: 'text-cyan-400', bar: 'bg-cyan-500' },
              { bg: 'bg-teal-500/20', border: 'border-teal-500/40', text: 'text-teal-400', bar: 'bg-teal-500' },
              { bg: 'bg-purple-500/20', border: 'border-purple-500/40', text: 'text-purple-400', bar: 'bg-purple-500' },
              { bg: 'bg-violet-500/20', border: 'border-violet-500/40', text: 'text-violet-400', bar: 'bg-violet-500' },
              { bg: 'bg-emerald-500/20', border: 'border-emerald-500/40', text: 'text-emerald-400', bar: 'bg-emerald-500' },
            ];
            const color = colors[index % colors.length];
            
            analyticsHTML += `
              <div class="bg-black/30 border ${color.border} rounded-xl p-4 hover:bg-black/40 transition-all duration-300 group">
                <div class="flex items-start justify-between mb-3">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <div class="w-3 h-3 ${color.bar} rounded-full"></div>
                      <h4 class="font-semibold text-textmain text-sm group-hover:${color.text} transition-colors">${app}</h4>
                    </div>
                    <p class="text-xs text-textsec ml-5">${percentage}% of total usage</p>
                  </div>
                  <div class="text-right">
                    <p class="text-2xl font-bold ${color.text}">${hours}<span class="text-sm">h</span></p>
                    ${minutes > 0 ? `<p class="text-xs text-textsec">${minutes}m</p>` : ''}
                  </div>
                </div>
                
                <div class="relative">
                  <div class="w-full bg-black/50 rounded-full h-2 overflow-hidden">
                    <div class="${color.bar} h-2 rounded-full transition-all duration-1000 ease-out" 
                         style="width: ${barWidth}%"></div>
                  </div>
                  <div class="absolute -top-1 right-0 text-xs ${color.text} font-semibold opacity-0 group-hover:opacity-100 transition-opacity">
                    ${time.toFixed(2)}h
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        appAnalyticsDiv.innerHTML = analyticsHTML;
      }
    })
    .catch(error => {
      console.error('Error loading chart data:', error);
      
      // Show error in all sections
      [lineCanvas, barCanvas].forEach(canvas => {
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#FF4D5A';
          ctx.font = '14px Inter';
          ctx.textAlign = 'center';
          ctx.fillText('âš  Error loading data', canvas.width / 2, canvas.height / 2 - 10);
          ctx.fillStyle = '#A9B3C1';
          ctx.font = '12px Inter';
          ctx.fillText('Please refresh the page', canvas.width / 2, canvas.height / 2 + 10);
        }
      });
      
      if (appAnalyticsDiv) {
        appAnalyticsDiv.innerHTML = `
          <div class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-red-500/50 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <p class="text-red-400 text-sm font-semibold">Failed to load analytics</p>
            <p class="text-textsec text-xs mt-2">Please refresh the page or try again later</p>
          </div>
        `;
      }
    });
}

// Mobile Sidebar Functions
function toggleMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.querySelector('.mobile-sidebar-overlay');
  
  if (sidebar && overlay) {
    sidebar.classList.toggle('mobile-open');
    overlay.classList.toggle('active');
  }
}

function closeMobileSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.querySelector('.mobile-sidebar-overlay');
  
  if (sidebar && overlay) {
    sidebar.classList.remove('mobile-open');
    overlay.classList.remove('active');
  }
}

// Enhanced selectChild function with mobile support
const originalSelectChild = window.selectChild;
window.selectChild = function(childHash) {
  originalSelectChild(childHash);
  closeMobileSidebar();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('Dashboard scripts initialized');
  
  // Test if selectChild function is available
  if (typeof window.selectChild === 'function') {
    console.log('selectChild function is available');
  } else {
    console.error('selectChild function is not available');
  }
  
  // Check if child items exist
  const childItems = document.querySelectorAll('.child-item');
  console.log('Found', childItems.length, 'child items');
});

// Add smooth scroll behavior
document.documentElement.style.scrollBehavior = 'smooth';
</script>
