<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  /* Map container - use attribute selector to match all child-specific maps */
  [id^="location-map-"] {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(35, 210, 226, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .leaflet-popup-content-wrapper {
    background: #162333 !important;
    color: #FFFFFF !important;
    border: 1px solid rgba(35, 210, 226, 0.3);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(35, 210, 226, 0.2);
  }

  .leaflet-popup-tip {
    background: #162333 !important;
    border: 1px solid rgba(35, 210, 226, 0.3);
  }

  .leaflet-popup-content {
    margin: 16px;
    font-family: 'Inter', sans-serif;
  }

  .popup-content {
    min-width: 200px;
  }

  .popup-title {
    font-size: 14px;
    font-weight: 700;
    color: #23D2E2;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .popup-detail {
    font-size: 12px;
    color: #A9B3C1;
    margin: 4px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .popup-detail svg {
    width: 14px;
    height: 14px;
    color: #7B6CF6;
    flex-shrink: 0;
  }

  .popup-coords {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 8px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #23D2E2;
    border: 1px solid rgba(35, 210, 226, 0.2);
    margin-top: 4px;
  }

  .leaflet-control-zoom a {
    background: #162333 !important;
    color: #23D2E2 !important;
    border-color: rgba(35, 210, 226, 0.3) !important;
  }

  .leaflet-control-zoom a:hover {
    background: #23D2E2 !important;
    color: #0F1B2A !important;
  }

  .leaflet-bar {
    border: 1px solid rgba(35, 210, 226, 0.3) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  .map-controls {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .control-btn {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.1), rgba(123, 108, 246, 0.1));
    border: 1px solid rgba(35, 210, 226, 0.3);
    color: #23D2E2;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .control-btn:hover {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.2), rgba(123, 108, 246, 0.2));
    border-color: #23D2E2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(35, 210, 226, 0.2);
  }

  .control-btn svg {
    width: 16px;
    height: 16px;
  }
</style>

<div class="glass-card group hover:border-primary/30 transition-all duration-300" id="location-section-{{ child_hash }}">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30 group-hover:scale-110 transition-transform duration-300">
        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>
      <div>
        <h3 class="text-textmain font-bold text-lg group-hover:text-primary transition-colors">Location History</h3>
        <p class="text-xs text-textsec">GPS tracking data</p>
      </div>
    </div>
  </div>
  
  <div class="location-map-container">
    {% if locations %}
      <div id="location-map-{{ child_hash }}"></div>
      <div class="map-controls">
        <button class="control-btn" onclick="fitAllMarkers('{{ child_hash }}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
          Fit All
        </button>
        <button class="control-btn" onclick="togglePath('{{ child_hash }}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
          Toggle Path
        </button>
        <button class="control-btn" onclick="showFirstLocation('{{ child_hash }}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
          </svg>
          First Location
        </button>
        <button class="control-btn" onclick="showLastLocation('{{ child_hash }}')">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
          Latest Location
        </button>
      </div>
    {% else %}
      <div class="text-center py-12 no-location-message">
        <svg class="w-16 h-16 mx-auto text-textsec/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        <p class="text-textsec text-sm font-medium">No location data available</p>
        <p class="text-textsec/60 text-xs mt-1">Location tracking data will appear here</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  {% if locations %}
  // Store location maps and data globally for each child
  if (!window.locationMaps) window.locationMaps = {};
  if (!window.locationData) window.locationData = {};
  if (!window.locationMarkers) window.locationMarkers = {};
  if (!window.pathLines) window.pathLines = {};
  if (!window.showPaths) window.showPaths = {};
  
  // Location data from Django for this child
  window.locationData['{{ child_hash }}'] = [
    {% for loc in locations %}
    {
      timestamp: '{{ loc.timestamp|date:"M d, Y H:i" }}',
      latitude: {{ loc.latitude }},
      longitude: {{ loc.longitude }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  window.showPaths['{{ child_hash }}'] = true;

  // Initialize map for specific child
  function initLocationMap(childHash) {
    const locationData = window.locationData[childHash];
    if (!locationData || locationData.length === 0) return;

    const mapId = 'location-map-' + childHash;
    const mapElement = document.getElementById(mapId);
    if (!mapElement) return;

    // Calculate center point
    const centerLat = locationData.reduce((sum, loc) => sum + loc.latitude, 0) / locationData.length;
    const centerLng = locationData.reduce((sum, loc) => sum + loc.longitude, 0) / locationData.length;

    // Initialize map
    window.locationMaps[childHash] = L.map(mapId, {
      center: [centerLat, centerLng],
      zoom: 12,
      zoomControl: true
    });

    // Add dark theme tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(window.locationMaps[childHash]);

    // Create custom icons
    const startIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #23D2E2, #18A4B4); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(35, 210, 226, 0.5); display: flex; align-items: center; justify-content: center;">
          <span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span>
      </div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const endIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #7B6CF6, #6B5CE6); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(123, 108, 246, 0.5); display: flex; align-items: center; justify-content: center;">
          <span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span>
      </div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const regularIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #18A4B4, #23D2E2); width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #0F1B2A; box-shadow: 0 4px 8px rgba(35, 210, 226, 0.4);">
      </div>`,
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    // Initialize markers array
    window.locationMarkers[childHash] = [];

    // Add markers
    locationData.forEach((loc, index) => {
      let icon = regularIcon;
      let label = `Location ${index + 1}`;
      
      if (index === 0) {
        icon = startIcon;
        label = 'Start Point';
      } else if (index === locationData.length - 1) {
        icon = endIcon;
        label = 'Latest Location';
      }

      const marker = L.marker([loc.latitude, loc.longitude], { icon })
        .addTo(window.locationMaps[childHash])
        .bindPopup(`
          <div class="popup-content">
            <div class="popup-title">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              </svg>
              ${label}
            </div>
            <div class="popup-detail">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              ${loc.timestamp}
            </div>
            <div class="popup-coords">
              ${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)}
            </div>
          </div>
        `);

      window.locationMarkers[childHash].push(marker);
    });

    // Draw path line connecting all locations
    const pathCoordinates = locationData.map(loc => [loc.latitude, loc.longitude]);
    window.pathLines[childHash] = L.polyline(pathCoordinates, {
      color: '#23D2E2',
      weight: 3,
      opacity: 0.8,
      smoothFactor: 1,
      dashArray: '10, 5'
    }).addTo(window.locationMaps[childHash]);

    // Fit map to show all markers
    if (locationData.length > 0) {
      const bounds = L.latLngBounds(pathCoordinates);
      window.locationMaps[childHash].fitBounds(bounds, { padding: [50, 50] });
    }
  }

  // Control functions
  function fitAllMarkers(childHash) {
    const locationMap = window.locationMaps[childHash];
    const locationData = window.locationData[childHash];
    if (locationMap && locationData && locationData.length > 0) {
      const pathCoordinates = locationData.map(loc => [loc.latitude, loc.longitude]);
      const bounds = L.latLngBounds(pathCoordinates);
      locationMap.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 0.5 });
    }
  }

  function togglePath(childHash) {
    const pathLine = window.pathLines[childHash];
    if (pathLine) {
      window.showPaths[childHash] = !window.showPaths[childHash];
      if (window.showPaths[childHash]) {
        pathLine.setStyle({ opacity: 0.8 });
      } else {
        pathLine.setStyle({ opacity: 0 });
      }
    }
  }

  function showFirstLocation(childHash) {
    const locationMap = window.locationMaps[childHash];
    const locationData = window.locationData[childHash];
    const locationMarkers = window.locationMarkers[childHash];
    if (locationMap && locationData && locationData.length > 0) {
      locationMap.setView([locationData[0].latitude, locationData[0].longitude], 15, { animate: true });
      locationMarkers[0].openPopup();
    }
  }

  function showLastLocation(childHash) {
    const locationMap = window.locationMaps[childHash];
    const locationData = window.locationData[childHash];
    const locationMarkers = window.locationMarkers[childHash];
    if (locationMap && locationData && locationData.length > 0) {
      const lastIndex = locationData.length - 1;
      locationMap.setView([locationData[lastIndex].latitude, locationData[lastIndex].longitude], 15, { animate: true });
      locationMarkers[lastIndex].openPopup();
    }
  }

  // Initialize map when the child dashboard becomes visible
  // Store initialization flag for this child
  if (!window.locationMapsInitialized) window.locationMapsInitialized = {};
  
  // Create observer to watch when the parent dashboard becomes visible
  document.addEventListener('DOMContentLoaded', function() {
    const childDashboard = document.getElementById('child-{{ child_hash }}');
    const locationSection = document.getElementById('location-section-{{ child_hash }}');
    
    if (childDashboard && locationSection) {
      // Create a MutationObserver to watch for visibility changes
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const isVisible = !childDashboard.classList.contains('hidden');
            
            // Initialize map only once when dashboard becomes visible
            if (isVisible && !window.locationMapsInitialized['{{ child_hash }}']) {
              window.locationMapsInitialized['{{ child_hash }}'] = true;
              
              setTimeout(() => {
                initLocationMap('{{ child_hash }}');
                
                // Force map to recalculate size after initialization
                setTimeout(() => {
                  if (window.locationMaps && window.locationMaps['{{ child_hash }}']) {
                    window.locationMaps['{{ child_hash }}'].invalidateSize();
                  }
                }, 200);
              }, 100);
            }
          }
        });
      });
      
      // Start observing the child dashboard for class changes
      observer.observe(childDashboard, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // Also check if it's already visible (in case it's the first/only child)
      if (!childDashboard.classList.contains('hidden') && !window.locationMapsInitialized['{{ child_hash }}']) {
        window.locationMapsInitialized['{{ child_hash }}'] = true;
        
        setTimeout(() => {
          initLocationMap('{{ child_hash }}');
          
          setTimeout(() => {
            if (window.locationMaps && window.locationMaps['{{ child_hash }}']) {
              window.locationMaps['{{ child_hash }}'].invalidateSize();
            }
          }, 200);
        }, 100);
      }
    }
  });
  {% endif %}
</script>