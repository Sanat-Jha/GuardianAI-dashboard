<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  #location-map {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(35, 210, 226, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  .leaflet-popup-content-wrapper {
    background: #162333 !important;
    color: #FFFFFF !important;
    border: 1px solid rgba(35, 210, 226, 0.3);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(35, 210, 226, 0.2);
  }

  .leaflet-popup-tip {
    background: #162333 !important;
    border: 1px solid rgba(35, 210, 226, 0.3);
  }

  .leaflet-popup-content {
    margin: 16px;
    font-family: 'Inter', sans-serif;
  }

  .popup-content {
    min-width: 200px;
  }

  .popup-title {
    font-size: 14px;
    font-weight: 700;
    color: #23D2E2;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .popup-detail {
    font-size: 12px;
    color: #A9B3C1;
    margin: 4px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .popup-detail svg {
    width: 14px;
    height: 14px;
    color: #7B6CF6;
    flex-shrink: 0;
  }

  .popup-coords {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 8px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #23D2E2;
    border: 1px solid rgba(35, 210, 226, 0.2);
    margin-top: 4px;
  }

  .leaflet-control-zoom a {
    background: #162333 !important;
    color: #23D2E2 !important;
    border-color: rgba(35, 210, 226, 0.3) !important;
  }

  .leaflet-control-zoom a:hover {
    background: #23D2E2 !important;
    color: #0F1B2A !important;
  }

  .leaflet-bar {
    border: 1px solid rgba(35, 210, 226, 0.3) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  .map-controls {
    margin-top: 16px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  .control-btn {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.1), rgba(123, 108, 246, 0.1));
    border: 1px solid rgba(35, 210, 226, 0.3);
    color: #23D2E2;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .control-btn:hover {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.2), rgba(123, 108, 246, 0.2));
    border-color: #23D2E2;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(35, 210, 226, 0.2);
  }

  .control-btn svg {
    width: 16px;
    height: 16px;
  }
</style>

<div class="glass-card group hover:border-primary/30 transition-all duration-300">
  <details class="group/details" id="location-details">
    <summary class="cursor-pointer flex items-center justify-between hover:translate-x-1 transition-transform duration-200">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30 group-hover:scale-110 transition-transform duration-300">
          <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-textmain font-bold text-lg group-hover:text-primary transition-colors">Location History</h3>
          <p class="text-xs text-textsec">GPS tracking data</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="bg-gradient-to-r from-primary/10 to-accent/10 text-primary px-3 py-1.5 rounded-lg text-sm font-bold border border-primary/30 shadow-lg shadow-primary/5">
          {{ location_count }} <span class="text-xs text-textsec font-normal">entries</span>
        </span>
        <svg class="w-5 h-5 text-primary group-open/details:rotate-180 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </summary>
    
    <div class="mt-6">
      {% if locations %}
        <div id="location-map"></div>
        <div class="map-controls">
          <button class="control-btn" onclick="fitAllMarkers()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
            </svg>
            Fit All
          </button>
          <button class="control-btn" onclick="togglePath()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Toggle Path
          </button>
          <button class="control-btn" onclick="showFirstLocation()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            First Location
          </button>
          <button class="control-btn" onclick="showLastLocation()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
            </svg>
            Latest Location
          </button>
        </div>
      {% else %}
        <div class="text-center py-12">
          <svg class="w-16 h-16 mx-auto text-textsec/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          <p class="text-textsec text-sm font-medium">No location data available</p>
          <p class="text-textsec/60 text-xs mt-1">Location tracking data will appear here</p>
        </div>
      {% endif %}
    </div>
  </details>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  {% if locations %}
  // Location data from Django
  const locationData = [
    {% for loc in locations %}
    {
      timestamp: '{{ loc.timestamp|date:"M d, Y H:i" }}',
      latitude: {{ loc.latitude }},
      longitude: {{ loc.longitude }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  let locationMap, pathLine, locationMarkers = [];
  let showPath = true;

  // Initialize map
  function initLocationMap() {
    if (locationData.length === 0) return;

    // Calculate center point
    const centerLat = locationData.reduce((sum, loc) => sum + loc.latitude, 0) / locationData.length;
    const centerLng = locationData.reduce((sum, loc) => sum + loc.longitude, 0) / locationData.length;

    // Initialize map
    locationMap = L.map('location-map', {
      center: [centerLat, centerLng],
      zoom: 12,
      zoomControl: true
    });

    // Add dark theme tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(locationMap);

    // Create custom icons
    const startIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #23D2E2, #18A4B4); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(35, 210, 226, 0.5); display: flex; align-items: center; justify-content: center;">
          <span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span>
      </div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const endIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #7B6CF6, #6B5CE6); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(123, 108, 246, 0.5); display: flex; align-items: center; justify-content: center;">
          <span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span>
      </div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const regularIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #18A4B4, #23D2E2); width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #0F1B2A; box-shadow: 0 4px 8px rgba(35, 210, 226, 0.4);">
      </div>`,
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    });

    // Add markers
    locationData.forEach((loc, index) => {
      let icon = regularIcon;
      let label = `Location ${index + 1}`;
      
      if (index === 0) {
        icon = startIcon;
        label = 'Start Point';
      } else if (index === locationData.length - 1) {
        icon = endIcon;
        label = 'Latest Location';
      }

      const marker = L.marker([loc.latitude, loc.longitude], { icon })
        .addTo(locationMap)
        .bindPopup(`
          <div class="popup-content">
            <div class="popup-title">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              </svg>
              ${label}
            </div>
            <div class="popup-detail">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              ${loc.timestamp}
            </div>
            <div class="popup-coords">
              ${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)}
            </div>
          </div>
        `);

      locationMarkers.push(marker);
    });

    // Draw path line connecting all locations
    const pathCoordinates = locationData.map(loc => [loc.latitude, loc.longitude]);
    pathLine = L.polyline(pathCoordinates, {
      color: '#23D2E2',
      weight: 3,
      opacity: 0.8,
      smoothFactor: 1,
      dashArray: '10, 5'
    }).addTo(locationMap);

    // Fit map to show all markers
    if (locationData.length > 0) {
      const bounds = L.latLngBounds(pathCoordinates);
      locationMap.fitBounds(bounds, { padding: [50, 50] });
    }
  }

  // Control functions
  function fitAllMarkers() {
    if (locationMap && locationData.length > 0) {
      const pathCoordinates = locationData.map(loc => [loc.latitude, loc.longitude]);
      const bounds = L.latLngBounds(pathCoordinates);
      locationMap.fitBounds(bounds, { padding: [50, 50], animate: true, duration: 0.5 });
    }
  }

  function togglePath() {
    if (pathLine) {
      showPath = !showPath;
      if (showPath) {
        pathLine.setStyle({ opacity: 0.8 });
      } else {
        pathLine.setStyle({ opacity: 0 });
      }
    }
  }

  function showFirstLocation() {
    if (locationMap && locationData.length > 0) {
      locationMap.setView([locationData[0].latitude, locationData[0].longitude], 15, { animate: true });
      locationMarkers[0].openPopup();
    }
  }

  function showLastLocation() {
    if (locationMap && locationData.length > 0) {
      const lastIndex = locationData.length - 1;
      locationMap.setView([locationData[lastIndex].latitude, locationData[lastIndex].longitude], 15, { animate: true });
      locationMarkers[lastIndex].openPopup();
    }
  }

  // Initialize map when details is opened
  const locationDetails = document.getElementById('location-details');
  let mapInitialized = false;

  locationDetails.addEventListener('toggle', (e) => {
    if (e.target.open && !mapInitialized) {
      setTimeout(() => {
        initLocationMap();
        mapInitialized = true;
      }, 100);
    }
  });
  {% endif %}
</script>
