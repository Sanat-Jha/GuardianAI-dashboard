
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- MapTiler SDK CSS -->
<link href="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.css" rel="stylesheet" />

<style>
  /* Map container */
  [id^="location-map-"] {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(35, 210, 226, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* Popup Styling */
  .leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: #162333 !important;
    color: #FFFFFF !important;
    border: 1px solid rgba(35, 210, 226, 0.3);
    box-shadow: 0 8px 32px rgba(35, 210, 226, 0.2);
  }
  
  .leaflet-popup-content {
    margin: 16px;
    font-family: 'Inter', sans-serif;
  }

  /* Custom Popup Content */
  .popup-title {
    font-size: 14px;
    font-weight: 700;
    color: #23D2E2;
    margin-bottom: 8px;
    display: flex; align-items: center; gap: 6px;
  }

  .popup-detail {
    font-size: 12px; color: #A9B3C1; margin: 4px 0;
    display: flex; align-items: center; gap: 6px;
  }

  .popup-coords {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 8px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: #23D2E2;
    border: 1px solid rgba(35, 210, 226, 0.2);
    margin-top: 4px;
  }

  /* Map Controls */
  .leaflet-control-zoom a {
    background: #162333 !important;
    color: #23D2E2 !important;
    border-color: rgba(35, 210, 226, 0.3) !important;
  }
  
  .leaflet-control-zoom a:hover {
    background: #23D2E2 !important;
    color: #0F1B2A !important;
  }

  .map-controls {
    margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;
  }

  .control-btn {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.1), rgba(123, 108, 246, 0.1));
    border: 1px solid rgba(35, 210, 226, 0.3);
    color: #23D2E2;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex; align-items: center; gap: 6px;
  }

  .control-btn:hover {
    background: linear-gradient(135deg, rgba(35, 210, 226, 0.2), rgba(123, 108, 246, 0.2));
    border-color: #23D2E2;
    transform: translateY(-2px);
  }
</style>

<!-- Map Layout (Unchanged) -->
<div class="glass-card group hover:border-primary/30 transition-all duration-300" id="location-section-{{ child_hash }}">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30 group-hover:scale-110 transition-transform duration-300">
        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
      </div>
      <div>
        <h3 class="text-textmain font-bold text-lg group-hover:text-primary transition-colors">Location History</h3>
        <p class="text-xs text-textsec">GPS tracking data</p>
      </div>
    </div>
  </div>
  
  <div class="location-map-container">
    {% if locations %}
      <div id="location-map-{{ child_hash }}"></div>
      <div class="map-controls">
        <button class="control-btn" onclick="fitAllMarkers('{{ child_hash }}')">Fit All</button>
        <button class="control-btn" onclick="togglePath('{{ child_hash }}')">Toggle Path</button>
        <button class="control-btn" onclick="showFirstLocation('{{ child_hash }}')">First</button>
        <button class="control-btn" onclick="showLastLocation('{{ child_hash }}')">Latest</button>
      </div>
    {% else %}
      <div class="text-center py-12 no-location-message">
         <p class="text-textsec text-sm font-medium">No location data available</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MapTiler SDK Plugin for Leaflet -->
<script src="https://cdn.maptiler.com/maptiler-sdk-js/v2.0.3/maptiler-sdk.umd.js"></script>
<script src="https://cdn.maptiler.com/leaflet-maptilersdk/v2.0.0/leaflet-maptilersdk.js"></script>

<script>
  {% if locations %}
  // Global storage
  window.locationMaps = window.locationMaps || {};
  window.locationData = window.locationData || {};
  window.locationMarkers = window.locationMarkers || {};
  window.pathLines = window.pathLines || {};
  window.showPaths = window.showPaths || {};
  
  // Locations come from backend in reverse chronological order (newest first)
  // Reverse them so index 0 = oldest (start), last index = newest (latest)
  window.locationData['{{ child_hash }}'] = [
    {% for loc in locations %}
    {
      timestamp: '{{ loc.timestamp|date:"M d, Y H:i" }}',
      latitude: {{ loc.latitude }},
      longitude: {{ loc.longitude }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ].reverse();

  window.showPaths['{{ child_hash }}'] = true;

  function initLocationMap(childHash) {
    const locationData = window.locationData[childHash];
    if (!locationData || locationData.length === 0) return;

    const mapId = 'location-map-' + childHash;
    const mapElement = document.getElementById(mapId);
    if (!mapElement) return;

    const centerLat = locationData.reduce((sum, loc) => sum + loc.latitude, 0) / locationData.length;
    const centerLng = locationData.reduce((sum, loc) => sum + loc.longitude, 0) / locationData.length;

    // Initialize Leaflet Map
    const map = L.map(mapId, {
      center: [centerLat, centerLng],
      zoom: 12,
      zoomControl: true
    });
    window.locationMaps[childHash] = map;

    // *** NEW MAPTILER INTEGRATION ***
    // This uses the SDK plugin which is more robust than raw tileLayer
    const mtLayer = L.maptilerLayer({
      apiKey: "GPanNrIqsBOyc09S4SL5",
      style: "019ab26a-2c4a-7571-ab36-a3ff18cc2e50", // Your Custom Style ID
    }).addTo(map);

    // Custom Icons (Kept same as before)
    const startIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #23D2E2, #18A4B4); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(35, 210, 226, 0.5); display: flex; align-items: center; justify-content: center;"><span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span></div>`,
      iconSize: [32, 32], iconAnchor: [16, 32]
    });

    const endIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #7B6CF6, #6B5CE6); width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid #0F1B2A; box-shadow: 0 4px 12px rgba(123, 108, 246, 0.5); display: flex; align-items: center; justify-content: center;"><span style="transform: rotate(45deg); color: #0F1B2A; font-weight: bold; font-size: 14px;">●</span></div>`,
      iconSize: [32, 32], iconAnchor: [16, 32]
    });

    const regularIcon = L.divIcon({
      className: 'custom-marker',
      html: `<div style="background: linear-gradient(135deg, #18A4B4, #23D2E2); width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid #0F1B2A; box-shadow: 0 4px 8px rgba(35, 210, 226, 0.4);"></div>`,
      iconSize: [24, 24], iconAnchor: [12, 24]
    });

    window.locationMarkers[childHash] = [];

    locationData.forEach((loc, index) => {
      let icon = regularIcon;
      let label = `Location ${index + 1}`;
      
      if (index === 0) { icon = startIcon; label = 'Start Point'; }
      else if (index === locationData.length - 1) { icon = endIcon; label = 'Latest Location'; }

      const marker = L.marker([loc.latitude, loc.longitude], { icon })
        .addTo(map)
        .bindPopup(`
          <div class="popup-content">
            <div class="popup-title">${label}</div>
            <div class="popup-detail">${loc.timestamp}</div>
            <div class="popup-coords">${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)}</div>
          </div>
        `);
      window.locationMarkers[childHash].push(marker);
    });

    // Draw Path
    const pathCoordinates = locationData.map(loc => [loc.latitude, loc.longitude]);
    window.pathLines[childHash] = L.polyline(pathCoordinates, {
      color: '#23D2E2', weight: 3, opacity: 0.8, smoothFactor: 1, dashArray: '10, 5'
    }).addTo(map);

    // Fit Bounds
    if (locationData.length > 0) {
      const bounds = L.latLngBounds(pathCoordinates);
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }

  // Control Functions (Kept same as before)
  function fitAllMarkers(childHash) {
    const map = window.locationMaps[childHash];
    const data = window.locationData[childHash];
    if (map && data && data.length) {
       const bounds = L.latLngBounds(data.map(l => [l.latitude, l.longitude]));
       map.fitBounds(bounds, { padding: [50, 50], animate: true });
    }
  }

  function togglePath(childHash) {
    const line = window.pathLines[childHash];
    if (line) {
      window.showPaths[childHash] = !window.showPaths[childHash];
      line.setStyle({ opacity: window.showPaths[childHash] ? 0.8 : 0 });
    }
  }

  function showFirstLocation(childHash) {
     const map = window.locationMaps[childHash];
     const data = window.locationData[childHash];
     const markers = window.locationMarkers[childHash];
     if (map && data && data.length) {
       map.setView([data[0].latitude, data[0].longitude], 15, { animate: true });
       markers[0].openPopup();
     }
  }

  function showLastLocation(childHash) {
     const map = window.locationMaps[childHash];
     const data = window.locationData[childHash];
     const markers = window.locationMarkers[childHash];
     if (map && data && data.length) {
       const last = data.length - 1;
       map.setView([data[last].latitude, data[last].longitude], 15, { animate: true });
       markers[last].openPopup();
     }
  }

  // Init Logic
  if (!window.locationMapsInitialized) window.locationMapsInitialized = {};
  document.addEventListener('DOMContentLoaded', function() {
    const childDashboard = document.getElementById('child-{{ child_hash }}');
    if (childDashboard) {
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            const isVisible = !childDashboard.classList.contains('hidden');
            if (isVisible && !window.locationMapsInitialized['{{ child_hash }}']) {
              window.locationMapsInitialized['{{ child_hash }}'] = true;
              setTimeout(() => {
                initLocationMap('{{ child_hash }}');
                setTimeout(() => {
                   if(window.locationMaps['{{ child_hash }}']) window.locationMaps['{{ child_hash }}'].invalidateSize();
                }, 200);
              }, 100);
            }
          }
        });
      });
      observer.observe(childDashboard, { attributes: true, attributeFilter: ['class'] });
      
      if (!childDashboard.classList.contains('hidden') && !window.locationMapsInitialized['{{ child_hash }}']) {
         window.locationMapsInitialized['{{ child_hash }}'] = true;
         setTimeout(() => {
             initLocationMap('{{ child_hash }}');
             setTimeout(() => {
                if(window.locationMaps['{{ child_hash }}']) window.locationMaps['{{ child_hash }}'].invalidateSize();
             }, 200);
         }, 100);
      }
    }
  });
  {% endif %}
</script>
