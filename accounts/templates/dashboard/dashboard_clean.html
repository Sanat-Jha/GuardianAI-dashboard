{% extends 'base.html' %}
{% load dashboard_filters %}

{% block header_controls %}
{% if children %}
<div class="flex items-center gap-3">
  {# Child Selector Dropdown #}
  <div class="relative">
    <select id="childSelector" 
            class="appearance-none bg-black/40 border border-primary/30 text-textmain rounded px-3 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all cursor-pointer hover:border-primary text-sm">
      <option value="">Select Child...</option>
      {% for child in children %}
        <option value="{{ child.child_hash }}">{{ child.get_full_name }}</option>
      {% endfor %}
    </select>
    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
      <svg class="w-3 h-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>
  </div>
  
  {# Add Child Button #}
  <button onclick="toggleAddChildModal()" class="btn-primary whitespace-nowrap">
    Add Child
  </button>
</div>
{% endif %}
{% endblock %}

{% block content %}

{# Add Child Modal #}
{% include 'dashboard/components/add_child_modal.html' %}

{# If no children exist, show empty state #}
{% if not children %}
  {% include 'dashboard/components/empty_state.html' %}
{% else %}
  {# Initial prompt to select a child #}
  <div id="selectPrompt">
    {% include 'dashboard/components/select_child_prompt.html' %}
  </div>
  
  {# Child-specific content containers (hidden by default) #}
  {% for child, data in children_data.items %}
    <div id="child-{{ child.child_hash }}" class="child-dashboard hidden">
      
      {# Child Info Card #}
      {% with child=child %}
        {% include 'dashboard/components/child_info_card.html' %}
      {% endwith %}
      
      {# Check if child has any data #}
      {% if data.has_data %}
        
        {# Statistics Grid #}
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          {% with label="Total Screen Time" value=data.stats.total_screen_time_hours subtitle="All-time usage" %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Average Daily" value=data.stats.avg_screen_time_formatted subtitle="Per day average" %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Locations Tracked" value=data.stats.location_count subtitle="Total GPS points" %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
          {% with label="Block Rate" value=data.stats.block_rate subtitle=data.stats.blocked_sites|stringformat:"d"|add:" blocked" %}
            {% include 'dashboard/components/stat_card.html' %}
          {% endwith %}
        </div>
        
        {# Charts Section #}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          {% with child_hash=child.child_hash %}
            {% include 'dashboard/components/screen_time_chart.html' %}
          {% endwith %}
          {% with child_hash=child.child_hash %}
            {% include 'dashboard/components/app_usage_chart.html' %}
          {% endwith %}
        </div>
        
        {# Top Apps List #}
        {% with top_apps=data.top_apps %}
          {% include 'dashboard/components/top_apps_list.html' %}
        {% endwith %}
        
        {# Detailed Data Sections #}
        <div class="mt-6 space-y-6">
          {% with locations=data.locations location_count=data.stats.location_count %}
            {% include 'dashboard/components/location_history.html' %}
          {% endwith %}
          
          {% with site_logs=data.site_logs site_count=data.stats.site_access_count %}
            {% include 'dashboard/components/site_access_log.html' %}
          {% endwith %}
          
          {% with screen_time_list=data.screen_time_list %}
            {% include 'dashboard/components/screen_time_details.html' %}
          {% endwith %}
        </div>
        
      {% else %}
        {# No data available for this child #}
        {% include 'dashboard/components/no_data_message.html' %}
      {% endif %}
      
    </div>
  {% endfor %}
{% endif %}

{# JavaScript #}
{% include 'dashboard/components/dashboard_scripts.html' %}

{# Styles #}
{% include 'dashboard/components/dashboard_styles.html' %}

{% endblock %}
